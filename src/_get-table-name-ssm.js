let aws = require('aws-sdk')

/**
 * reads dynamo tables generated by cfn from ssm
 */
module.exports = function getTableNameSSM(callback) {
  let tablename = false
  if (tablename) {
    callback(null, tablename)
  }
  else {
    getTbl(function done(err, name) {
      if (err) callback(err)
      else {
        tablename = name
        callback(null, tablename)
      }
    })
  }
}

function getTbl(callback) {
  let ssm = new aws.SSM
  let Path = `/${process.env.ARC_CLOUDFORMATION}`
  ssm.getParametersByPath({Path, Recursive:true}, function done(err, result) {
    if (err) callback(err)
    else {
      let table = param=> param.Name.split('/')[2] === 'tables'
      let tables = result.Parameters.filter(table).reduce((a, b)=> {
        a[b.Name.split('/')[3]] = b.Value
        return a
      }, {})
      if (!tables.data) {
        callback(ReferenceError('begin/data requires a table named data'))
      }
      else {
        callback(null, tables.data)
      }
    }
  })
}
